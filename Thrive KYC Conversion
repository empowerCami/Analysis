drop table if exists #loanDriver
select 
distinct a.userId 
, a.UserLoanApplicationId 
, a.progress as loanApplicationProgress
, case when a.progress = 6 then 1 else 0 end as kyc_started_ind
, case when a.progress >= 7 then 1 else 0 end as kyc_ended_ind
, case when a.progress >= 6 then 1 else 0 end as kyc_started_and_beyond
, a.CreatedAt as loanApplicationCreatedAt
, convert(varchar(7), a.CreatedAt , 23) as app_month
, RANK() OVER(PARTITION BY a.UserLoanApplicationId ORDER BY a.CreatedAt DESC) AS app_status_rank -- rank = 1 pulls most recent
, b.LoanId 
, b.Status as finalAppLoanStatus
, b.CreatedAt as loanCreatedAt
into #loanDriver
from UserLoanApplications a
left join loans b 
on a.UserLoanApplicationId = b.UserLoanApplicationId
order by a.userId
;

drop table if exists #thrive_caserate_driver
select 
app_month 
, count(distinct UserLoanApplicationId) as total_apps
, sum(kyc_started_ind) as tot_kyc_started 
, sum(kyc_ended_ind) as tot_kyc_finished
, sum(kyc_started_and_beyond) as tot_kyc_started_beyond
into #thrive_caserate_driver
from #loanDriver 
group by app_month 
;

select 
app_month 
, total_apps
, tot_kyc_started 
, tot_kyc_finished
, kyc_denom 
, (cast(tot_kyc_finished as float) / cast(kyc_denom as float)) as kyc_conversion 
, (cast(tot_kyc_started as float) / cast(kyc_denom as float)) as kyc_dropoff 
from #thrive_caserate_driver2
order by app_month
;
