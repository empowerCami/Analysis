drop table if exists #paused_sub_starter
select 
distinct UserSubscriptionId 
, InvoiceDate 
into #paused_sub_starter
from UserSubscriptionInvoice
where invoiceDate >= '2022-03-01'
order by UserSubscriptionId
;

drop table if exists #paused_sub_starter2
select 
distinct UserSubscriptionId  
, InvoiceDate
, row_number() over(partition by UserSubscriptionId order by InvoiceDate asc) as row_num
into #paused_sub_starter2
from #paused_sub_starter
order by UserSubscriptionId, row_num
;
drop table if exists #paused_sub_starter3
select 
distinct UserSubscriptionId 
, row_num
, InvoiceDate
, dateadd(month, 1, InvoiceDate ) as next_month
into #paused_sub_starter3 
from #paused_sub_starter2 
where 1=1 
--and UserSubscriptionId = 714857 --paused sub example
;
drop table if exists #paused_sub_starter4
select 
a.*
, b.next_month 
into #paused_sub_starter4
from #paused_sub_starter2 a
left join #paused_sub_starter3 b
on a.invoiceDate = b.next_month and  a.UserSubscriptionId = b.UserSubscriptionId 
where 1=1 
--and a.UserSubscriptionId = 714857 --paused sub example
order by row_num
;
drop table if exists #Paused_Sub_DRIVER
select 
* 
, row_num as return_row_num
, InvoiceDate as return_month
, dateadd(month, -1, InvoiceDate) as a_skipped_month
, 1 as pauser_indicator
into #Paused_Sub_DRIVER
from #paused_sub_starter4 
where row_num > 1 
and next_month is null 
;
drop table if exists #Pausers_and_NotPausers
select 
a.* 
, b.return_row_num
, b.return_month
, b.a_skipped_month 
, b.pauser_indicator
into #Pausers_and_NotPausers
from #paused_sub_starter4 a 
left join #Paused_Sub_DRIVER b
on a.UserSubscriptionId = b.UserSubscriptionId
;
drop table if exists #BeforePauseMonthCheck
select
UserSubscriptionId
, invoiceDate as before_pause_month
into #BeforePauseMonthCheck
from #Pausers_and_NotPausers
where pauser_indicator = 1
and row_num = (return_row_num - 1)
;
drop table if exists #Pausers_and_NotPausers2
select 
a.* 
, b.before_pause_month
into #Pausers_and_NotPausers2
from #Pausers_and_NotPausers a
left join #BeforePauseMonthCheck b 
on a.UserSubscriptionId = b.UserSubscriptionId 
;
